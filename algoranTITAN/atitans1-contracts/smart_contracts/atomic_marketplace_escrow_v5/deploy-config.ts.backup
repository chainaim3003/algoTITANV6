import { AlgorandClient } from '@algorandfoundation/algokit-utils'
import { AtomicMarketplaceEscrowV5Factory } from '../artifacts/atomic_marketplace_escrow_v5/AtomicMarketplaceEscrowV5Client'
import * as fs from 'node:fs'
import * as path from 'node:path'

export async function deploy() {
  console.log('====================================')
  console.log('üöÄ Deploying Atomic Marketplace Escrow V5...')
  console.log('====================================')
  
  const algorand = AlgorandClient.fromEnvironment()
  const deployer = await algorand.account.fromEnvironment('DEPLOYER')
  
  console.log(`üìù Deployer: ${deployer.addr}`)
  
  const treasuryAddress = deployer.addr
  const settlementAssetId = 0  // ALGO
  
  console.log(`üíµ Settlement: ${settlementAssetId === 0 ? 'ALGO (native)' : `Asset ${settlementAssetId}`}`)
  console.log(`üí∞ Treasury: ${treasuryAddress}`)
  
  try {
    // Use exact same pattern as V3 - this works
    const factory = algorand.client.getTypedAppFactory(AtomicMarketplaceEscrowV5Factory, {
      defaultSender: deployer.addr,
    })
    
    console.log('üì¶ Deploying contract...')
    
    const { appClient, result } = await factory.deploy({
      onUpdate: 'append',
      onSchemaBreak: 'append',
    })
    
    const appId = appClient.appClient.appId
    const appAddress = appClient.appAddress
    
    console.log(`‚úÖ Contract deployed!`)
    console.log(`üìç App ID: ${appId}`)
    console.log(`üìç App Address: ${appAddress}`)
    console.log(`üìç Operation: ${result.operationPerformed}`)
    
    // Check initialization
    let needsInit = false
    
    if (['create', 'replace'].includes(result.operationPerformed)) {
      needsInit = true
      console.log('üÜï New deployment - initialization required')
    } else {
      console.log('üîç Checking if contract is already initialized...')
      try {
        const appInfo = await algorand.client.algod.getApplicationByID(appId).do()
        const globalState = appInfo.params['global-state'] || []
        
        const hasSettlement = globalState.some((item: any) => 
          Buffer.from(item.key, 'base64').toString() === 'settlementCurrency'
        )
        const hasTreasury = globalState.some((item: any) => 
          Buffer.from(item.key, 'base64').toString() === 'platformTreasury'
        )
        
        if (!hasSettlement || !hasTreasury) {
          console.log('‚ö†Ô∏è  Contract exists but is NOT initialized')
          needsInit = true
        } else {
          console.log('‚úÖ Contract is already initialized')
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è  Could not verify initialization, assuming needs init')
        needsInit = true
      }
    }
    
    // Initialize if needed - using EXACT pattern from V3
    if (needsInit) {
      console.log('')
      console.log('‚öôÔ∏è  Initializing contract...')
      
      // Fund app account FIRST
      console.log('üí∞ Funding app account for box storage...')
      await algorand.send.payment({
        amount: (2).algo(),
        sender: deployer.addr,
        receiver: appAddress,
      })
      console.log(`‚úÖ App account funded with 2 ALGO`)
      
      // Call initialize using AlgoKit typed client pattern
      console.log('üîß Calling initialize method...')


      // Call initialize using AlgoKit typed client pattern
        console.log('üîß Calling initialize method...')


const initResult = await appClient.send.initialize({
  args: {
    settlementAssetId: BigInt(settlementAssetId),
    treasuryAddress: treasuryAddress,
  },
  sendParams: {
    fee: (2000).microAlgo(),
  },
})


      console.log(`‚úÖ Contract initialized!`)
      console.log(`üìç Txn ID: ${initResult.transaction.txID()}`)
      
      // Verify
      console.log('üîç Verifying initialization...')
      const verifyInfo = await algorand.client.algod.getApplicationByID(appId).do()
      const verifyState = verifyInfo.params['global-state'] || []
      
      const settlementSet = verifyState.some((item: any) => 
        Buffer.from(item.key, 'base64').toString() === 'settlementCurrency'
      )
      const treasurySet = verifyState.some((item: any) => 
        Buffer.from(item.key, 'base64').toString() === 'platformTreasury'
      )
      
      if (settlementSet && treasurySet) {
        console.log('‚úÖ Initialization verified!')
      } else {
        console.warn('‚ö†Ô∏è  Warning: Some global state values may not be set')
      }
    }
    
    console.log('')
    console.log('====================================')
    console.log('‚úÖ AtomicMarketplaceEscrowV5 READY!')
    console.log('====================================')
    console.log(`üìç App ID: ${appId}`)
    console.log(`üìç App Address: ${appAddress}`)
    console.log(`üíµ Settlement: ${settlementAssetId === 0 ? 'ALGO (native)' : `Asset ${settlementAssetId}`}`)
    console.log(`üí∞ Treasury: ${treasuryAddress}`)
    console.log(`‚öñÔ∏è  Default Rates:`)
    console.log(`   - Regulator Tax: 5.00%`)
    console.log(`   - Regulator Refund: 2.00%`)
    console.log(`   - Marketplace Fee: 0.25%`)
    console.log('')
    
    // Detect network from environment
    const networkName = process.env.ALGOD_SERVER?.includes('testnet') ? 'testnet' : 
                       process.env.ALGOD_SERVER?.includes('mainnet') ? 'mainnet' : 'localnet'
    const explorerUrl = networkName === 'mainnet' 
      ? `https://explorer.perawallet.app/application/${appId}`
      : networkName === 'testnet'
      ? `https://testnet.explorer.perawallet.app/application/${appId}`
      : `https://app.dappflow.org/explorer/application/${appId}`
    
    console.log(`üîó Explorer: ${explorerUrl}`)
    
    // Auto-update contracts.json
    if (needsInit || result.operationPerformed === 'create' || result.operationPerformed === 'replace') {
      console.log('')
      console.log('üìù Auto-updating contract registry...')
      
      try {
        const contractsJsonPath = path.resolve(__dirname, '../../../atitans1-frontend/src/config/contracts.json')
        
        if (fs.existsSync(contractsJsonPath)) {
          const contractsData = JSON.parse(fs.readFileSync(contractsJsonPath, 'utf8'))
          
          contractsData.active.ESCROW_V5 = {
            appId: appId,
            appAddress: appAddress,
            network: networkName,
            version: '5.0.0',
            deployedAt: new Date().toISOString().split('T')[0],
            status: 'active',
            description: 'Fully initialized and ready for trades',
            contractName: 'AtomicMarketplaceEscrowV5'
          }
          
          if (contractsData.active.ESCROW_V4) {
            if (!contractsData.deprecated) contractsData.deprecated = {}
            contractsData.deprecated.ESCROW_V4 = {
              ...contractsData.active.ESCROW_V4,
              deprecatedAt: new Date().toISOString().split('T')[0],
              status: 'deprecated',
              reason: 'Replaced by V5'
            }
            delete contractsData.active.ESCROW_V4
          }
          
          fs.writeFileSync(contractsJsonPath, JSON.stringify(contractsData, null, 2))
          console.log('‚úÖ contracts.json updated!')
        }
      } catch (error: any) {
        console.warn('‚ö†Ô∏è  Auto-update failed:', error.message)
      }
    }
    
    console.log('')
    console.log('üéâ DEPLOYMENT COMPLETE!')
    console.log('')
    
    return {
      appId,
      appAddress,
      operationPerformed: result.operationPerformed,
      settlementAssetId,
      treasuryAddress,
      initialized: needsInit,
    }
  } catch (error) {
    console.error('‚ùå Deployment failed:', error)
    throw error
  }
}
